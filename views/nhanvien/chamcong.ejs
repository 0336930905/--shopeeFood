<%- include('../partials/nv_trangdau') %>
  <style>
    .highlight-today {
      position: relative;
    }

    .highlight-today::before {
      content: 'Hôm nay';
      top: 0;
      left: 0;
      /* Điều chỉnh vị trí */
      transform: translateY(-50%);
      background-color: #f44336;
      /* Màu nền của thẻ chỉ ra */
      color: white;
      padding: 2px 5px;
      border-radius: 3px;
    }

    .boder-red {
      border: 2px solid red;
    }
  </style>
  <div class="container ">
      <!-- Form for starting shift -->
      <div class="row">
        <div class="col-5">
            <h2 class="mt-4">Chấm công</h2>
            <% schedules.forEach(function(lich) { 
                const isToday = new Date(lich.NGAY_L).toLocaleDateString('vi-VN') === new Date().toLocaleDateString('vi-VN'); 
                if (isToday) { 
                    const hours = currentHours; 
                    let ca = null; 
                    let shiftId = lich.ID_LL; // Lấy ID_LL của lịch làm
                    
                    if (lich.CA_1 && hours >= 7 && hours < 12) {  
                        ca = 1; 
                    %>
                        <p style="color: #333;">Hiện tại là thời gian của ca 1. <%= lich.CA_1_TEN_NV %></p>
                    <% } else if (lich.CA_2 && hours >= 12 && hours < 17) { 
                        ca = 2; 
                    %>
                        <p style="color: #333;">Hiện tại là thời gian của ca 2. <%= lich.CA_2_TEN_NV %></p>
                    <% } else if (lich.CA_3 && hours >= 17 && hours < 23) { 
                        ca = 3; 
                    %>
                        <p style="color: #333;">Hiện tại là thời gian của ca 3. <%= lich.CA_3_TEN_NV %></p>
                    <% } else { %>
                        <p style="color: #333;">Hiện tại không nằm trong giờ làm việc.</p>
                    <% } 
                    
                    if (ca && ((ca === 1 && lich.CA_1 === employeeId) || (ca === 2 && lich.CA_2 === employeeId) || (ca === 3 && lich.CA_3 === employeeId))) { %>
                        <div style="display: flex;">
                            <form id="startForm" action="/nhanvien/chamcong/start" method="POST">
                                <input type="hidden" name="shiftId" value="<%= shiftId %>">
                                <button id="startButton" type="submit" class="btn-bt">Giờ vào</button>
                            </form>
                            <!-- Form for ending shift -->
                            <form id="endForm" action="/nhanvien/chamcong/end" method="POST">
                                <input type="hidden" name="shiftId" value="<%= shiftId %>">
                                <button id="endButton" type="submit" class="btn btn-xoa">Giờ ra &nbsp;</button>
                            </form>
                        </div>
                    <% } 
                } 
            }); %>
                <!-- Form for selecting month -->
    <form id="selectMonthForm" action="/nhanvien/chamcong" method="GET" class="form-inline">
    <div class="display-flex">
      <div class="form-group mb-2" style="margin-right: 10px;">
        <label for="month" class="mr-2">Chọn tháng:</label>
        <select id="month" name="month" class="form-control mr-2" required>
          <option value="">Chọn tháng</option>
          <% for (var i=1; i <=12; i++) { %>
            <option value="<%= i %>">Tháng <%= i %>
            </option>
            <% } %>
        </select>
      </div>
      <div class="form-group mb-2">
        <label for="year" class="mr-2">Chọn năm:</label>
        <select id="year" name="year" class="form-control mr-2" required>
          <option value="">Chọn năm</option>
          <% for (var i=new Date().getFullYear(); i>= 2000; i--) { %>
            <option value="<%= i %>">
              <%= i %>
            </option>
            <% } %>
        </select>
      </div>
    </div>
      <button type="submit" class="btn btn-secondary mb-2">Xem chấm công</button>
    </form>
    <!-- Table for displaying attendance records -->
    <div class="table-responsive mt-3" style="max-height: 300px;">
      <table class="table table-striped table-bordered">
        <thead class="thead-dark">
          <tr>
            <th scope="col">Ngày</th>
            <th scope="col">Giờ vào</th>
            <th scope="col">Giờ ra</th>
          </tr>
        </thead>
        <tbody>
          <% if (typeof attendances !=='undefined' && attendances.length> 0) { %>
            <% attendances.forEach(record=> { %>
              <tr>
                <td>
                  <%= new Date(record.NGAY_L).toLocaleDateString('vi-VN') %>
                </td>
                <td>
                  <%= record.THOIGIANVAOCA %>
                </td>
                <td>
                  <%= record.THOIGIANKETCA %>
                </td>
              </tr>
              <% }) %>
                <% } else { %>
                  <tr>
                    <td colspan="3" class="text-center">Không có dữ liệu chấm công cho tháng này.</td>
                  </tr>
                  <% } %>
        </tbody>
      </table>
    </div>
        </div>
    
        <div class="col-7 chuyendoi" style="margin-right: 0px;">
            <h2 class="mt-4">Lịch làm</h2>
            <div class="mt-4">
                <div class="display-flex">
                    <div id="clock" style="font-size: 18px;"></div>
                </div>
                <div class="table-responsive">
                    <div class="display-flex">
                        <div style="width: 120px;">Ngày làm</div>
                        <div style="width: 150px;">Ca 1</div>
                        <div style="width: 150px;">Ca 2</div>
                        <div style="width: 150px;">Ca 3</div>
                    </div>
                    <% schedules.forEach(function(lich) { 
                        const isToday = new Date(lich.NGAY_L).toLocaleDateString('vi-VN') === new Date().toLocaleDateString('vi-VN'); 
                    %>
                        <div class="<%= isToday ? 'highlight-today' : '' %>">
                            <div class="table table-bordered <%= isToday ? 'boder-red' : '' %>">
                                <tr>
                                    <td>
                                        <input type="text" name="id_sp" value="<%= new Date(lich.NGAY_L).toLocaleDateString('vi-VN') %>" readonly style="width: 120px;">
                                    </td>
                                    <td>
                                        <input type="text" name="id_sp" value="<%= lich.CA_1_TEN_NV ? lich.CA_1_TEN_NV : 'Chưa phân công' %>" readonly style="width: 150px;">
                                    </td>
                                    <td>
                                        <input type="text" name="id_sp" value="<%= lich.CA_2_TEN_NV ? lich.CA_2_TEN_NV : 'Chưa phân công' %>" readonly style="width: 150px;">
                                    </td>
                                    <td>
                                        <input type="text" name="id_sp" value="<%= lich.CA_3_TEN_NV ? lich.CA_3_TEN_NV : 'Chưa phân công' %>" readonly style="width: 150px;">
                                    </td>
                                </tr>
                            </div>
                        </div>
                    <% }); %>
                </div>
            </div>
        </div>
    </div>
    

  </div>
  </div>
  <script>
    function updateClock() {
      var now = new Date();
      // Chuyển đổi thời gian hiện tại sang múi giờ UTC+7
      var options = {
        timeZone: 'Asia/Ho_Chi_Minh',
        weekday: 'long',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      };
      var formatter = new Intl.DateTimeFormat('vi-VN', options);
      var formattedDate = formatter.format(now);

      document.getElementById('clock').innerText = formattedDate;
    }

    // Cập nhật đồng hồ mỗi giây
    setInterval(updateClock, 1000);

    // Gọi hàm updateClock ngay lập tức để hiển thị thời gian ngay khi tải trang
    updateClock();
    document.addEventListener('DOMContentLoaded', function() {
    // Get current date
    const now = new Date();
    const currentMonth = now.getMonth() + 1; // Months are zero-indexed
    const currentYear = now.getFullYear();

    // Set the current month in the select element
    const monthSelect = document.getElementById('month');
    monthSelect.value = currentMonth;

    // Set the current year in the select element
    const yearSelect = document.getElementById('year');
    yearSelect.value = currentYear;
  });
  </script>

  <%- include('../partials/nv_trangcuoi') %>